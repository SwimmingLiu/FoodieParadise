# “好吃嘴儿” 产品设计文档

## 背景介绍

“好吃嘴儿” 是一个微信小程序，该小程序中包含三个功能“去哪吃”、“查预制”、“吃多少”三个功能。

- 去哪吃：让每个用户上传一张在饭店随手拍的照片（可能是别人拍的），用AI自动推理出该饭店的准确位置。介绍对应饭店的信息，并展示饭店的详细位置
- 查预制：让用户上传一张食品的图片，用AI自动分析当前的菜品信息（菜品名称、做法、菜品介绍等），然后根据图片分析该菜品是否为预制菜，并给出打分（百分比）。
- 吃多少：让用户通过上传一张食品的图片，用AI自动分析当前食品的热量。同时在原图上标注每个食品的热量。

## 技术栈要求

| 模块     | 选型方案               | 关键配置/版本                    |
| :------- | :--------------------- | :------------------------------- |
| 前端框架 | Uni-app (Vue 3 + Vite) | 编译目标：微信小程序 (mp-weixin) |
| 后端框架 | Python FastAPI         | 异步模式 (async/await)           |
| AI 编排  | LangGraph + LangChain  | 用于构建状态机 Agent             |
| 通信协议 | HTTP Chunked Transfer  | 模拟 SSE，实现流式打字机效果     |
| 地图服务 | 微信原生 API           | wx.openLocation+wx.getLocation   |

### 前端 (Mini Program Client)

- **基础框架**：使用 Uni-app (Vue 3 语法) 构建，确保组件化开发。
- **流式网络请求 (关键)**：
  - **禁止**使用 `uni.request`（不支持分块）。
  - **必须**使用微信原生 API `wx.request`。
  - **参数配置**：设置 `enableChunked: true` 以接收流式响应。
  - **数据处理**：监听 `onChunkReceived` 回调，利用 `TextDecoder` 解析 `ArrayBuffer` 为字符串。
- **渲染组件**：
  - 使用支持流式追加的 Markdown 渲染库（如 `mp-html` 或自定义 parser）。
  - **UI 布局**：需设计独立的“思考折叠区”（展示 `THOUGHT` 内容）和“回答区”（展示 `ANSWER` 内容）。
- **地图交互**：
  - 通过识别后端返回的特定 JSON 结构（如 `{"type": "map", "lat": ..., "lng": ...}`）渲染为可点击卡片。
  - 点击卡片触发 `wx.openLocation`，传入经纬度、名称和地址。

### 后端 (Python Server)

- **服务架构**：FastAPI，全链路异步设计。
- **AI Agent 逻辑**：
  - 使用 **LangGraph** 定义图结构（StateGraph）。
  - 节点设计：至少包含 `Agent`（决策）和 `Tools`（执行）两个节点。
  - 工具集：集成搜索工具及自定义的“地点查询工具”（返回经纬度数据）。
- **流式响应 (Streaming)**：
  - 使用 `fastapi.responses.StreamingResponse`。
  - **Generator 设计**：必须能够捕获 LangGraph 的 `on_chat_model_stream`（输出 token）和 `on_tool_start`（工具调用状态）。
- **协议设计 (Custom Protocol)**：
  自定义流式事件格式，用于区分不同类型的数据包：
  - `event: thought\ndata: 正在查询高得地图...\n\n` —— (用于前端思考区)
  - `event: message\ndata: 我为你找到了...\n\n` —— (用于前端正文区)
  - `event: function_call\ndata: {"action": "open_map", "lat": 30.1, "lng": 120.1}\n\n` —— (用于前端渲染交互卡片)

### 基础设施与部署

- **HTTPS**：小程序强制要求域名备案及 HTTPS 证书。
- **Nginx**：配置反向代理时，必须关闭缓存（`proxy_buffering off`），否则流式响应会被 Nginx 攒成一坨一次性返回，导致打字机效果失效。

## 素材介绍

[素材目录](/Users/swimmingliu/data/github-proj/FoodieParadise/assets) 中包含的都是前端可能会用到的一些图标，你可以根据名称进行挑选

【注】如果当你需要新的图标的时候，你可以调用 `nano-banana` 自动生成对应的图片

## 功能介绍

### 首页

“好吃嘴儿”首页包含三个功能板块分别为 “去哪吃”、“查预制”、“吃多少” 

菜单栏包括 “首页” 和 “我的” 两个 `bar` 

具体页面可以参考 [首页图-菜单栏](/Users/swimmingliu/data/github-proj/FoodieParadise/assets/首页图-菜单栏.png)、[首页图](/Users/swimmingliu/data/github-proj/FoodieParadise/assets/首页图.png)

### 去哪吃

#### 首页

- 轮播图：展示一系列样本图片，作为“去哪吃”板块的样本参考。每个轮播图配备预设的问题，点击图片之后，会自动根据问题和图片进行提问
- 上传图片按钮：用户点击按钮之后，可以上传一张图片，并且输入对应的问题进行提问。（问题框上方会预设三个问题，“图片的位置在哪儿”、“杭州在哪儿能吃到图片中的东西”、“图片中的饭馆是什么？”）

#### 结果页

- 对话记录：
  - 首先，右侧会显示用户选择的图片和问题。
  - 然后，左侧会显示一个思考列表（动态刷新LLM的思考过程）
- 结果：AI给出最终的结果，如果AI识别出具体的位置，则需要给出对应地址的介绍信息，以及显示微信地址

- 微信地址：点击结果中的微信地址信息，会自动下转到微信地址功能页面
- 分享功能：可以将当前的结果页面，通过分享的方式，分享到微信朋友圈或者微信好友

### 查预制

#### 首页

- 上传图片按钮：用户点击按钮之后，可以上传一张菜品的图片。（提示用户尽量在光线充足的情况下进行拍照）

#### 结果页

- 思考过程：显示一个思考列表（动态刷新LLM的思考过程）
- 图片信息推理：AI首先分析当前图片中的信息，判断图片中的菜品名称、新鲜层度（预制、新鲜出炉、半预制）、可信度
- 详细分析报告：给出AI分析的所有依据
- 分享功能：可以将当前的结果页面，通过分享的方式，分享到微信朋友圈或者微信好友

### 吃多少

#### 首页

- 上传图片按钮：用户点击按钮之后，可以上传一张菜品的图片。（提示用户尽量在光线充足的情况下进行拍照）

#### 结果页

- 结果图片：分析图片中每种食物的热量，然后在图片中标注出每种食物的热量。
- 分析报告：根据图片中的内容，给出每种食物热量分析的报告
- 分享功能：可以将当前的结果页面，通过分享的方式，分享到微信朋友圈或者微信好友

### 我的

在”我的页面“，包含用户的头像、昵称、历史记录。

点击历史记录，可以看到“去哪吃”、“查预制”、“吃多少”三个板块的历史记录

